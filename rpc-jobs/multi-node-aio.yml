- project:
    name: onmetal-all-in-one-deploy-rpc
    deploy-action:
        - Setup_Host:
            script: setup-host.sh
        - Setup_Cobbler:
            script: setup-cobbler.sh
        - Virtual_Networks:
            script: setup-virsh-net.sh
        - Deploy_VMs:
            script: deploy-vms.sh
        - OpenStack_Setup:
            script: deploy-osa.sh
    jobs:
        - 'OnMetal_Multi_Node_AIO_{deploy-action}'

- job-template:
    name: 'OnMetal_Multi_Node_AIO_{deploy-action}'
    project-type: workflow
    build-discarder:
        days-to-keep: 30
    concurrent: true
    parameters:
        - label:
            name: NODE
            description: "Name of Jenkins node to run on"
        - string:
            name: OPENSTACK_ANSIBLE_BRANCH
            default: stable/newton
            description: Used only in OnMetal_Multi_Node_AIO_OpenStack_Setup
        - string:
            name: DEFAULT_IMAGE
            default: '16.04'
            description: Used only in OnMetal_Multi_Node_AIO_Setup_Cobbler
        - bool:
            name: PARTITION_HOST
            default: true
            description: Used only in OnMetal_Multi_Node_AIO_Setup_Host
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/openstack/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
    dsl: |
        node(env.NODE){
        }

- job:
    name: 'OnMetal_Multi_Node_AIO_Prepare_Deployment'
    project-type: workflow
    build-discarder:
        days-to-keep: 30
    concurrent: true
    parameters:
        - label:
            name: NODE
            description: "Name of Jenkins node to run on"
        - string:
            name: OPENSTACK_ANSIBLE_BRANCH
            default: stable/newton
            description: Used only in OnMetal_Multi_Node_AIO_OpenStack_Setup
        - string:
            name: DEFAULT_IMAGE
            default: '16.04'
            description: Used only in OnMetal_Multi_Node_AIO_Setup_Cobbler
        - bool:
            name: PARTITION_HOST
            default: true
            description: Used only in OnMetal_Multi_Node_AIO_Setup_Host
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/openstack/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
    dsl: |
        node(env.NODE){
            dir("rpc-gating"){
                git url: "https://github.com/melissa-kam/rpc-gating", branch: "temp"
            }
            dir("openstack-ansible-ops"){
                git url: env.OSA_OPS_REPO, branch: env.OSA_OPS_BRANCH
            }
            def run_script = load 'rpc-gating/pipeline-steps/run_script.groovy'

            dir("openstack-ansible-ops/multi-node-aio"){
                stage ('Setup Host'){
                    environment_vars = ["PARTITION_HOST=${env.PARTITION_HOST}"]
                    run_script.call (
                        script: 'setup-host.sh',
                        environment_vars: environment_vars
                    )
                }
                stage ('Setup_Cobbler'){
                    run_script (
                        SCRIPT: setup-host.sh,
                        DEFAULT_IMAGE: env.DEFAULT_IMAGE
                    )
                }
                stage ('Virtual_Networks'){
                    run_script (
                        SCRIPT: setup-virsh-net.sh
                    )
                }
                stage ('Deploy_VMs'){
                    run_script (
                        SCRIPT: deploy-vms.sh
                    )
                }
                stage ('OpenStack_Setup'){
                    run_script (
                        SCRIPT: deploy-osa.sh,
                        OSA_BRANCH: env.OPENSTACK_ANSIBLE_BRANCH
                    )
                }
            }

        }
