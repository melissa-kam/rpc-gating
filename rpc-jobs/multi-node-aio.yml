- project:
    name: onmetal-all-in-one-deploy-rpc
    deploy-action:
        - Setup-Host:
            script: setup-host.sh
        - Setup-Cobbler:
            script: setup-cobbler.sh
        - Virtual-Networks:
            script: setup-virsh-net.sh
        - Deploy-VMs:
            script: deploy-vms.sh
        - OpenStack-Setup:
            script: deploy-osa.sh
    jobs:
        - 'OnMetal-AIO-{deploy-action}'

- job-template:
    name: 'OnMetal-AIO-{deploy-action}'
    build-discarder:
        days-to-keep: 30
    concurrent: true
    parameters:
        - label:
            name: NODE
            description: "Name of Jenkins node to run on"
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/openstack/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
        - string:
            name: OSA_BRANCH
            default: stable/mitaka
            description: Used only in OnMetal-AIO-OpenStack-Setup
        - bool:
            name: PARTITION_HOST
            default: true
            description: Used only in OnMetal-AIO-Setup-Host
    scm:
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
            wipe-workspace: false
    wrappers:
        - mask-passwords
    builders:
        - onmetal-aio-setup-script-builder:
            script: "{script}"

- builder:
    name: onmetal-aio-setup-script-builder
    description: Runs specified multi-node-aio script
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            export OSA_BRANCH=$OSA_BRANCH
            export PARTITION_HOST=$PARTITION_HOST
            export RUN_OSA=false
            export SSHKEY=$(sudo cat /root/.ssh/id_rsa.pub)
            sudo -E ./{script}
